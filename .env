TWILIO_ACCOUNT_SID=ACf6d8be2abdc95bd71209...
TWILIO_AUTH_TOKEN=95c1bff1aea1a7d7e899066660f...
TWILIO_PHONE_NUMBER=+14847799491
USER_PHONE_NUMBER=+16189228172
PIN_CODE=7071

nano app/main.py

from flask import Flask, request
from twilio.rest import Client
from twilio.twiml.voice_response import VoiceResponse, Gather
import os
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)

# Twilio credentials
account_sid = os.getenv('TWILIO_ACCOUNT_SID')
auth_token = os.getenv('TWILIO_AUTH_TOKEN')
twilio_number = os.getenv('TWILIO_PHONE_NUMBER')
user_number = os.getenv('USER_PHONE_NUMBER')
correct_pin = os.getenv('PIN_CODE')

client = Client(account_sid, auth_token)

# Store recordings temporarily (in production, use a database)
call_data = {}

@app.route('/start-call', methods=['GET', 'POST'])
def start_call():
    """Trigger a call to the user's phone"""
    try:
        call = client.calls.create(
            to=user_number,
            from_=twilio_number,
            url=request.url_root + 'voice/pin'
        )
        return f"Call initiated! Call SID: {call.sid}"
    except Exception as e:
        return f"Error: {str(e)}", 500

@app.route('/voice/pin', methods=['POST'])
def voice_pin():
    """Ask for PIN entry"""
    response = VoiceResponse()
    gather = Gather(
        num_digits=4,
        finish_on_key='#',
        action='/voice/check-pin',
        method='POST'
    )
    gather.say("Please enter your 4-digit PIN, then press the pound key.")
    response.append(gather)
    return str(response)

@app.route('/voice/check-pin', methods=['POST'])
def voice_check_pin():
    """Verify the PIN"""
    response = VoiceResponse()
    digits = request.form.get('Digits', '')
    
    if digits == correct_pin:
        response.say("Thank you.")
        response.redirect('/voice/question/1')
    else:
        response.say("That PIN was not recognized. Goodbye.")
        response.hangup()
    
    return str(response)

@app.route('/voice/question/<int:n>', methods=['POST'])
def voice_question(n):
    """Ask question N"""
    response = VoiceResponse()
    call_sid = request.form.get('CallSid')
    
    # Initialize call data if needed
    if call_sid not in call_data:
        call_data[call_sid] = {}
    
    questions = {
        1: "Question 1. Briefly describe the situation that happened. When you are finished, press the pound key."
    }
    
    if n in questions:
        response.say(questions[n])
        response.record(
            finish_on_key='#',
            action=f'/voice/menu/{n}',
            method='POST'
        )
    else:
        response.say("All questions complete. Your answers are saved. Goodbye.")
        response.hangup()
    
    return str(response)

@app.route('/voice/menu/<int:n>', methods=['POST'])
def voice_menu(n):
    """Present 3-option menu after recording"""
    response = VoiceResponse()
    call_sid = request.form.get('CallSid')
    recording_url = request.form.get('RecordingUrl')
    
    # Store the recording
    if call_sid not in call_data:
        call_data[call_sid] = {}
    call_data[call_sid][f'q{n}'] = recording_url
    
    gather = Gather(
        num_digits=1,
        action=f'/voice/handle-menu/{n}',
        method='POST'
    )
    gather.say("Press 1 to save this answer and go to the next question. Press 2 to erase and re-record this answer. Press 3 to hear your answer.")
    response.append(gather)
    
    return str(response)

@app.route('/voice/handle-menu/<int:n>', methods=['POST'])
def voice_handle_menu(n):
    """Handle menu choice"""
    response = VoiceResponse()
    digits = request.form.get('Digits')
    call_sid = request.form.get('CallSid')
    
    if digits == '1':  # Save and continue
        if n < 1:  # For now, we only have 1 question
            response.redirect(f'/voice/question/{n+1}')
        else:
            response.say("Your answer is saved. Goodbye.")
            response.hangup()
    elif digits == '2':  # Re-record
        response.redirect(f'/voice/question/{n}')
    elif digits == '3':  # Playback
        recording_url = call_data.get(call_sid, {}).get(f'q{n}')
        if recording_url:
            response.play(recording_url)
            gather = Gather(
                num_digits=1,
                action=f'/voice/handle-menu/{n}',
                method='POST'
            )
            gather.say("Press 1 to save this answer, or 2 to erase and re-record it.")
            response.append(gather)
        else:
            response.say("Recording not found.")
            response.redirect(f'/voice/question/{n}')
    
    return str(response)

if __name__ == '__main__':
    app.run(debug=True, port=5000)


